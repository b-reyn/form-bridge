FROM python:3.12-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    jq \
    aws-cli \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Install Python testing dependencies
COPY requirements-test.txt .
RUN pip install --no-cache-dir -r requirements-test.txt

# Install additional testing tools
RUN pip install --no-cache-dir \
    pytest==7.4.3 \
    pytest-cov==4.1.0 \
    pytest-mock==3.12.0 \
    pytest-html==4.1.1 \
    pytest-json-report==1.5.0 \
    pytest-localstack==0.5.0 \
    moto[all]==4.2.14 \
    boto3==1.34.0 \
    requests==2.31.0 \
    faker==21.0.0 \
    hypothesis==6.92.2 \
    testcontainers==3.7.1

# Install security scanning tools
RUN pip install --no-cache-dir \
    bandit[toml]==1.7.5 \
    safety==2.3.5 \
    semgrep==1.45.0

# Install performance testing tools
RUN pip install --no-cache-dir \
    locust==2.17.0 \
    memory-profiler==0.61.0

# Create directories for test results
RUN mkdir -p /app/test-results/coverage-html \
    /app/test-results/security \
    /app/test-results/performance

# Copy test configuration files
COPY pytest.ini .
COPY .coveragerc .
COPY bandit.yml .
COPY pyproject.toml .

# Set environment variables for testing
ENV PYTHONPATH=/app/lambdas:/app/tests
ENV PYTEST_CURRENT_TEST=""

# Default command
CMD ["pytest", "tests/", "-v", "--cov=lambdas", "--cov-report=html", "--cov-report=term-missing"]