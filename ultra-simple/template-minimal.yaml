AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Form-Bridge Ultra-Simple: Ingestion + Read API + DynamoDB ($0/month for testing)'

Parameters:
  Environment:
    Type: String
    Default: test
    AllowedValues: [test, prod]
    Description: Deployment environment
    
  AdminPassword:
    Type: String
    Description: Admin password for read API dashboard authentication
    Default: admin123
    NoEcho: true

Resources:
  # =========================================
  # Form Ingestion Lambda (Ultra-Optimized)
  # =========================================
  
  FormHandler:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'form-bridge-ultra-${Environment}'
      Description: 'Ultra-simple form handler - WordPress plugin compatible'
      CodeUri: ./
      Handler: handler.lambda_handler
      Runtime: python3.12
      # Ultra-minimal cost configuration
      MemorySize: 128          # Lowest cost tier
      Timeout: 15              # Fast execution expected
      Architectures:
        - x86_64               # Avoid ARM64 deployment complexity
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment
          TABLE_NAME: !Ref DataTable
          # Use Secrets Manager in production (commented for ultra-simple)
          HMAC_SECRET: 'development-secret-change-in-production'
          # HMAC_SECRET: !Sub '{{resolve:secretsmanager:form-bridge-${Environment}::SecretString:secret}}'
      # Lambda Function URL - Direct HTTPS endpoint
      FunctionUrlConfig:
        AuthType: NONE         # We handle auth in the function
        InvokeMode: BUFFERED   # Synchronous
        Cors:
          AllowOrigins:
            - '*'              # Restrict in production
          AllowMethods:
            - POST
          AllowHeaders:
            - Content-Type
            - X-Signature
            - X-Timestamp
          MaxAge: 86400        # Cache preflight 24 hours
      # Minimal IAM permissions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref DataTable
            
  # =========================================
  # Read API Lambda Function (Admin Access)
  # =========================================
  
  ReadHandler:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'form-bridge-read-${Environment}'
      Description: 'Read form submissions API for admin dashboard'
      CodeUri: ./
      Handler: read-submissions.lambda_handler
      Runtime: python3.12
      # Optimized for read operations
      MemorySize: 256          # More memory for data processing
      Timeout: 30              # Allow more time for queries
      Architectures:
        - x86_64               # Match ingestion function
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment
          TABLE_NAME: !Ref DataTable
          ADMIN_PASSWORD: !Ref AdminPassword
      # Lambda Function URL for admin access
      FunctionUrlConfig:
        AuthType: NONE         # We handle basic auth in the function
        InvokeMode: BUFFERED   # Synchronous
        Cors:
          AllowOrigins:
            - '*'              # Restrict in production to admin domain
          AllowMethods:
            - GET
            - POST
          AllowHeaders:
            - Content-Type
            - Authorization
          MaxAge: 86400        # Cache preflight 24 hours
      # Read-only IAM permissions
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:Scan
                - dynamodb:Query
                - dynamodb:GetItem
              Resource: !GetAtt DataTable.Arn

  # ===============================
  # Single DynamoDB Table (Minimal)
  # ===============================
  
  DataTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'form-bridge-ultra-${Environment}'
      # Pay per request - zero cost for no usage
      BillingMode: PAY_PER_REQUEST
      # Minimal schema for flexibility
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      # TTL for automatic cleanup (cost savings)
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      # Minimal encryption (AWS managed, free)
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: FormBridge-Ultra

  # ===============================
  # Optional: HMAC Secret (Production)
  # ===============================
  
  # Uncomment for production use
  # HMACSecret:
  #   Type: AWS::SecretsManager::Secret
  #   Properties:
  #     Name: !Sub 'form-bridge-${Environment}'
  #     Description: 'HMAC secret for form authentication'
  #     GenerateSecretString:
  #       SecretStringTemplate: '{}'
  #       GenerateStringKey: 'secret'
  #       PasswordLength: 32
  #       ExcludeCharacters: '"@/\'

# ===============================
# Outputs
# ===============================

Outputs:
  LambdaFunctionUrl:
    Description: 'WordPress plugin endpoint (ingestion)'
    Value: !GetAtt FormHandlerUrl.FunctionUrl
    Export:
      Name: !Sub '${AWS::StackName}-endpoint'
      
  ReadLambdaFunctionUrl:
    Description: 'Admin dashboard endpoint (read API)'
    Value: !GetAtt ReadHandlerUrl.FunctionUrl
    Export:
      Name: !Sub '${AWS::StackName}-read-endpoint'

  DynamoDBTable:
    Description: 'Data storage table'
    Value: !Ref DataTable
    Export:
      Name: !Sub '${AWS::StackName}-table'

  TestIngestCommand:
    Description: 'Test form submission'
    Value: !Sub |
      curl -X POST ${FormHandlerUrl.FunctionUrl} \
        -H "Content-Type: application/json" \
        -H "X-Signature: $(echo -n "$(date +%s):{}" | openssl dgst -sha256 -hmac 'development-secret-change-in-production' | cut -d' ' -f2)" \
        -H "X-Timestamp: $(date +%s)" \
        -d '{"form_data":{"test":"data"}}'
        
  TestReadCommand:
    Description: 'Test reading submissions (admin)'
    Value: !Sub |
      curl -X GET ${ReadHandlerUrl.FunctionUrl} \
        -H "Authorization: Basic $(echo -n 'admin:[PASSWORD]' | base64)"
        
  AdminDashboardInfo:
    Description: 'Admin dashboard access'
    Value: !Sub |
      URL: [See ReadLambdaFunctionUrl output]
      Username: admin
      Password: [See AdminPassword parameter]
      Endpoints:
        - GET / (list submissions)
        - GET /stats (statistics)

  CostEstimate:
    Description: 'Estimated monthly cost'
    Value: '$0.00 (AWS Free Tier: 1M Lambda requests, 400K GB-seconds, 25GB DynamoDB)'

  ScalingInfo:
    Description: 'When to upgrade'
    Value: 'Upgrade to full architecture at 10K+ requests/month or advanced admin features'